<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Litteraturhuset ‚Äî Dagsoversikt</title>
    
    <!-- PWA -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#0d0d0f">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- iOS PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dagsoversikt">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #111113;
            --bg-tertiary: #1a1a1d;
            --border: #2a2a2d;
            --text-primary: #e8e8eb;
            --text-secondary: #8a8a8f;
            --text-muted: #5a5a5f;
            
            /* Status colors - matching PowerShell */
            --status-active: #00d4ff;      /* Cyan - arrangement p√•g√•r */
            --status-rigg: #ffffff;         /* White - rigg p√•g√•r */
            --status-getin: #ffd700;        /* Yellow - get-in */
            --status-getout: #888888;       /* Gray - get-out */
            --status-pending: #4a4a4f;      /* Dark gray - venter */
            --status-finished: #3a3a3f;     /* Darker - ferdig */
            
            --accent: #ff6b35;
            --accent-dim: #ff6b3540;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* iOS safe areas */
        html {
            background: var(--bg-primary);
        }
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            line-height: 1.5;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* Prevent pull-to-refresh on iOS */
        body {
            overscroll-behavior-y: contain;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        
        /* Header */
        header {
            border-bottom: 1px solid var(--border);
            padding-bottom: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo {
            font-size: 0.75rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        
        h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.75rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }
        
        .date-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        
        .weekday {
            text-transform: capitalize;
            color: var(--accent);
        }
        
        /* Day toggle */
        .day-toggle {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }
        
        .day-btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            padding: 0.625rem 1.25rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .day-btn:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }
        
        .day-btn.active {
            background: var(--accent);
            color: var(--bg-primary);
            font-weight: 600;
        }
        
        /* Status bar */
        .status-bar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .refresh-info {
            font-family: 'JetBrains Mono', monospace;
        }
        
        .refresh-btn {
            margin-left: auto;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.4rem 0.75rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.2s;
        }
        
        .refresh-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
        }
        
        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .refresh-btn.loading .refresh-icon {
            animation: spin 1s linear infinite;
        }
        
        .refresh-icon {
            font-size: 1rem;
            line-height: 1;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Table */
        .table-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 2rem;
        }
        
        .table-header {
            display: grid;
            grid-template-columns: 110px 160px 100px 1fr 100px;
            gap: 1rem;
            padding: 1rem 1.25rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            border-radius: 12px 12px 0 0;
        }
        
        .event-row {
            display: grid;
            grid-template-columns: 110px 160px 100px 1fr 100px;
            gap: 1rem;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            transition: background 0.2s ease;
            align-items: center;
        }
        
        .event-row.has-drawer-open {
            background: var(--bg-tertiary);
        }
        
        .event-row:last-child {
            border-bottom: none;
        }
        
        .event-row:hover {
            background: var(--bg-tertiary);
        }
        
        /* Status-based coloring */
        .event-row.status-active {
            color: var(--status-active);
            background: rgba(0, 212, 255, 0.05);
        }
        
        .event-row.status-active .active-indicator {
            display: inline-block;
        }
        
        .event-row.status-rigg {
            color: var(--status-rigg);
            background: rgba(255, 255, 255, 0.03);
        }
        
        .event-row.status-getin {
            color: var(--status-getin);
            background: rgba(255, 215, 0, 0.05);
        }
        
        .event-row.status-getout {
            color: var(--accent);
            background: rgba(255, 107, 53, 0.08);
        }
        
        .event-row.status-pending {
            color: var(--status-pending);
        }
        
        .event-row.status-finished {
            color: var(--status-finished);
        }
        
        .active-indicator {
            display: none;
            margin-left: 0.5rem;
            color: var(--status-active);
            animation: blink 1s ease-in-out infinite;
        }
        
        .getout-indicator {
            display: none;
            margin-left: 0.5rem;
            color: var(--accent);
            animation: blink 0.8s ease-in-out infinite;
        }
        
        .event-row.status-getout .getout-indicator {
            display: inline-block;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .rigg-tid {
            white-space: nowrap;
            font-weight: 600;
        }
        
        .rigg-tider-list {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .rigg-tider-list span {
            display: block;
            line-height: 1.3;
        }
        
        .room {
            font-weight: 600;
        }
        
        .rigg-indicator {
            color: var(--accent);
            margin-left: 2px;
        }
        
        .teknikere {
            color: var(--text-secondary);
        }
        
        .teknikere.empty {
            color: var(--text-muted);
        }
        
        .arrangor {
            font-family: 'Space Grotesk', sans-serif;
        }
        
        .arrangor-title {
            cursor: pointer;
            color: inherit;
            text-decoration: none;
            transition: color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .arrangor-title:hover {
            color: var(--accent);
        }
        
        .arrangor-title .web-icon {
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.7rem;
        }
        
        .arrangor-title:hover .web-icon {
            opacity: 1;
        }
        
        .arrangor-title.has-sanity::after {
            content: '‚ñæ';
            margin-left: 0.25rem;
            font-size: 0.7rem;
            opacity: 0.5;
            transition: transform 0.2s;
        }
        
        .arrangor-title.has-sanity.open::after {
            transform: rotate(180deg);
        }
        
        /* Event drawer - skuff under event-raden */
        .event-drawer {
            display: none;
            grid-column: 1 / -1;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border);
            padding: 1.25rem;
            margin: 0 -1.25rem -1rem -1.25rem;
            margin-top: 1rem;
        }
        
        .event-drawer.open {
            display: block;
            animation: drawerSlide 0.2s ease-out;
        }
        
        @keyframes drawerSlide {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 500px; }
        }
        
        .drawer-content {
            display: flex;
            gap: 1.5rem;
        }
        
        .drawer-image {
            width: 140px;
            height: 140px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--bg-secondary);
            flex-shrink: 0;
        }
        
        .drawer-image.placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 3rem;
        }
        
        .drawer-info {
            flex: 1;
            min-width: 0;
        }
        
        .drawer-title {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        
        .drawer-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 0.75rem;
            font-size: 0.8rem;
        }
        
        .drawer-meta-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            color: var(--text-secondary);
        }
        
        .drawer-meta-item.highlight {
            color: var(--accent);
            font-weight: 500;
        }
        
        .drawer-meta-item .icon {
            font-size: 0.9rem;
        }
        
        .drawer-ingress {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .drawer-links {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .drawer-link {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        .drawer-link:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
        }
        
        .drawer-link.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
        }
        
        .drawer-link.primary:hover {
            background: #ff8555;
            border-color: #ff8555;
        }
        
        /* Mobile drawer */
        @media (max-width: 768px) {
            .drawer-content {
                flex-direction: column;
            }
            
            .drawer-image {
                width: 100%;
                height: 180px;
            }
        }
        
        /* Tekniker drawer */
        .tekniker-navn {
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .tekniker-navn:hover,
        .tekniker-navn.active {
            color: var(--accent);
        }
        
        .tekniker-drawer {
            display: none;
            grid-column: 1 / -1;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border);
            padding: 1rem 1.25rem;
            margin: 0 -1.25rem -1rem -1.25rem;
            margin-top: 1rem;
        }
        
        .tekniker-drawer.open {
            display: block;
            animation: drawerSlide 0.2s ease-out;
        }
        
        .tekniker-drawer-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .tekniker-bilde {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--bg-secondary);
        }
        
        .tekniker-info {
            flex: 1;
        }
        
        .tekniker-navn-full {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 500;
            font-size: 1rem;
            color: var(--text-primary);
        }
        
        /* Vert drawer */
        .vert-name.clickable {
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .vert-name.clickable:hover,
        .vert-name.active {
            color: var(--accent);
        }
        
        .vert-drawer {
            display: none;
            width: 100%;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border);
            padding: 1rem;
            margin-top: 0.875rem;
            margin-bottom: -0.875rem;
            margin-left: -1rem;
            margin-right: -1rem;
            padding-left: 1rem;
            padding-right: 1rem;
            border-radius: 0 0 8px 8px;
        }
        
        .vert-drawer.open {
            display: block;
            animation: drawerSlide 0.2s ease-out;
        }
        
        .vert-drawer-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .vert-bilde {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--bg-secondary);
        }
        
        .vert-info {
            flex: 1;
        }
        
        .vert-navn-full {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        
        .arr-tid {
            text-align: right;
            white-space: nowrap;
            font-weight: 600;
        }
        
        /* Verter section */
        .section-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }
        
        .verter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }
        
        .vert-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.875rem 1rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        
        .vert-card.active {
            border-color: var(--status-active);
            color: var(--status-active);
            background: rgba(0, 212, 255, 0.05);
        }
        
        .vert-tid {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .vert-card.active .vert-tid {
            color: var(--status-active);
            opacity: 0.7;
        }
        
        /* Legend */
        .legend {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        
        .legend-color.rigg { background: var(--status-rigg); }
        .legend-color.getin { background: var(--status-getin); }
        .legend-color.active { background: var(--status-active); }
        .legend-color.getout { background: var(--accent); }
        .legend-color.pending { background: var(--status-pending); }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
            font-style: italic;
        }
        
        /* Finished section */
        .finished-section {
            margin-top: 1.5rem;
        }
        
        .finished-toggle {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-muted);
            transition: all 0.2s ease;
            width: 100%;
            text-align: left;
        }
        
        .finished-toggle:hover {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        
        .finished-toggle .chevron {
            transition: transform 0.2s ease;
        }
        
        .finished-toggle.open .chevron {
            transform: rotate(90deg);
        }
        
        .finished-count {
            background: var(--bg-tertiary);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
        }
        
        .finished-container {
            display: none;
            margin-top: 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .finished-container.open {
            display: block;
        }
        
        .finished-container .event-row {
            opacity: 0.6;
        }
        
        .finished-container .event-row:hover {
            opacity: 0.8;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            h1 {
                font-size: 1.25rem;
            }
            
            .table-header {
                display: none;
            }
            
            .event-row {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                padding: 1rem;
            }
            
            .event-row > * {
                width: 100%;
            }
            
            .event-row .arrangor {
                font-size: 1rem;
                font-weight: 500;
                order: -1;
            }
            
            .event-row .rigg-tid,
            .event-row .arr-tid {
                font-size: 0.8rem;
            }
            
            .arr-tid {
                text-align: left;
            }
            
            .mobile-label {
                display: inline;
                color: var(--text-muted);
                font-size: 0.7rem;
                text-transform: uppercase;
                margin-right: 0.5rem;
            }
            
            .verter-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-label {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div>
                    <div class="logo">Litteraturhuset</div>
                    <h1>Dagsoversikt</h1>
                    <div class="date-display">
                        <span class="weekday" id="weekday">‚Äî</span>
                        <span id="date-text">‚Äî</span>
                    </div>
                </div>
                <div class="day-toggle">
                    <button class="day-btn active" data-day="today">I dag</button>
                    <button class="day-btn" data-day="tomorrow">I morgen</button>
                </div>
            </div>
            <div class="status-bar">
                <div class="status-indicator"></div>
                <span>Live</span>
                <span class="refresh-info">¬∑ Oppdatert <span id="last-update">‚Äî</span></span>
                <button class="refresh-btn" id="refresh-btn" title="Hent ny data fra Momentus">
                    <span class="refresh-icon">‚Üª</span>
                    <span class="refresh-text">Oppdater</span>
                </button>
            </div>
        </header>
        
        <main>
            <div class="table-container">
                <div class="table-header">
                    <div>Rigg</div>
                    <div>Rom</div>
                    <div>Teknikere</div>
                    <div>Arrang√∏r</div>
                    <div style="text-align: right">Arr.tid</div>
                </div>
                <div id="events-container">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Henter data...
                    </div>
                </div>
            </div>
            
            <!-- Ferdige arrangementer -->
            <div class="finished-section" id="finished-section" style="display: none;">
                <button class="finished-toggle" id="finished-toggle">
                    <span class="chevron">‚ñ∂</span>
                    <span>Ferdige arrangementer</span>
                    <span class="finished-count" id="finished-count">0</span>
                </button>
                <div class="finished-container" id="finished-container">
                    <div id="finished-events"></div>
                </div>
            </div>
            
            <div class="section-title">Verter</div>
            <div class="verter-grid" id="verter-container">
                <div class="loading">Henter...</div>
            </div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color rigg"></div>
                    <span>Rigg p√•g√•r</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color getin"></div>
                    <span>Get-in</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color active"></div>
                    <span>Arrangement p√•g√•r</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color getout"></div>
                    <span>Get-out ‚èè</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color pending"></div>
                    <span>Venter</span>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        let currentDay = 'today';
        let refreshInterval;
        
        // Day toggle
        document.querySelectorAll('.day-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentDay = btn.dataset.day;
                loadData();
            });
        });
        
        async function loadData() {
            try {
                const response = await fetch(`/api/data/${currentDay}`);
                const data = await response.json();
                
                // Debug: sjekk sanity data
                const withSanity = data.arrangementer.filter(e => e.sanity && e.sanity.url);
                console.log(`Arrangementer: ${data.arrangementer.length}, med Sanity-match: ${withSanity.length}`);
                
                // Debug: sjekk tekniker data
                data.arrangementer.forEach((e, i) => {
                    if (e.teknikere) {
                        console.log(`Event ${i} teknikere:`, e.teknikere);
                    }
                });
                
                // Update header
                document.getElementById('weekday').textContent = data.weekday;
                document.getElementById('date-text').textContent = data.date_display;
                
                // Separer aktive/kommende fra ferdige
                const activeEvents = data.arrangementer.filter(e => e.status !== 'finished');
                const finishedEvents = data.arrangementer.filter(e => e.status === 'finished');
                
                // Render aktive events
                renderEvents(activeEvents);
                
                // Render ferdige events
                renderFinishedEvents(finishedEvents);
                
                // Render verter
                renderVerter(data.verter);
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('events-container').innerHTML = 
                    '<div class="empty-state">Kunne ikke hente data. Pr√∏v igjen senere.</div>';
            }
        }
        
        function renderEvents(events) {
            const container = document.getElementById('events-container');
            
            if (!events || events.length === 0) {
                container.innerHTML = '<div class="empty-state">Ingen arrangementer denne dagen</div>';
                return;
            }
            
            container.innerHTML = events.map((event, index) => {
                // Vis alle riggetider hvis det er flere
                let riggTidHtml;
                if (event.rigg_tider && event.rigg_tider.length > 1) {
                    riggTidHtml = `<div class="rigg-tider-list">${event.rigg_tider.map(t => `<span>${t}</span>`).join('')}</div>`;
                } else {
                    riggTidHtml = event.rigg_tid || '‚Äî';
                }
                
                // Teknikere - n√• som objekter med bilde
                let teknikereHtml = '‚Äî';
                let teknikereClass = 'empty';
                if (event.teknikere && event.teknikere.length > 0) {
                    teknikereClass = '';
                    teknikereHtml = event.teknikere.map((tek, tekIdx) => 
                        `<span class="tekniker-navn" data-tekniker="${index}-${tekIdx}">${tek.fornavn}</span>`
                    ).join(', ');
                }
                
                // Tekniker-drawer (skjult til klikk)
                let teknikerDrawerHtml = '';
                if (event.teknikere && event.teknikere.length > 0) {
                    teknikerDrawerHtml = event.teknikere.map((tek, tekIdx) => `
                        <div class="tekniker-drawer" id="tekniker-drawer-${index}-${tekIdx}">
                            <div class="tekniker-drawer-content">
                                <img src="${tek.bilde}" class="tekniker-bilde" alt="${tek.navn}" onerror="this.style.display='none'">
                                <div class="tekniker-info">
                                    <div class="tekniker-navn-full">${tek.navn}</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
                
                const arrangor = event.arrangor || '(ingen)';
                const arrangorTruncated = arrangor.length > 30 ? arrangor.substring(0, 28) + '...' : arrangor;
                const riggIndicator = event.rigg_count > 1 ? `<span class="rigg-indicator">${'‚öô'.repeat(event.rigg_count)}</span>` : '';
                
                // Sanity info for drawer
                const hasSanity = event.sanity && event.sanity.url;
                const sanityClass = hasSanity ? 'has-sanity' : '';
                
                // Bygg drawer HTML hvis vi har Sanity-match
                let drawerHtml = '';
                if (hasSanity) {
                    const s = event.sanity;
                    const imageHtml = s.bilde 
                        ? `<img src="${s.bilde}?w=280&h=280&fit=crop" class="drawer-image" alt="">`
                        : `<div class="drawer-image placeholder">üìö</div>`;
                    
                    const ingressHtml = s.ingress 
                        ? `<div class="drawer-ingress">${s.ingress}</div>`
                        : '';
                    
                    // Meta-info (arrang√∏r, pris, kategori, varighet)
                    let metaItems = [];
                    if (s.arrangor) {
                        metaItems.push(`<div class="drawer-meta-item"><span class="icon">üë§</span> ${s.arrangor}</div>`);
                    }
                    if (s.pris) {
                        metaItems.push(`<div class="drawer-meta-item highlight"><span class="icon">üé´</span> ${s.pris}</div>`);
                    }
                    if (s.varighet) {
                        metaItems.push(`<div class="drawer-meta-item"><span class="icon">‚è±Ô∏è</span> ${s.varighet} min</div>`);
                    }
                    if (s.kategori) {
                        metaItems.push(`<div class="drawer-meta-item"><span class="icon">üìÇ</span> ${s.kategori}</div>`);
                    }
                    const metaHtml = metaItems.length > 0 
                        ? `<div class="drawer-meta">${metaItems.join('')}</div>` 
                        : '';
                    
                    drawerHtml = `
                        <div class="event-drawer" id="drawer-${index}">
                            <div class="drawer-content">
                                ${imageHtml}
                                <div class="drawer-info">
                                    <div class="drawer-title">${s.tittel || arrangor}</div>
                                    ${metaHtml}
                                    ${ingressHtml}
                                    <div class="drawer-links">
                                        <a href="${s.url}" target="_blank" class="drawer-link primary">üåê Se p√• nettside</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="event-row status-${event.status}">
                        <div class="rigg-tid">
                            <span class="mobile-label">Rigg:</span>
                            ${riggTidHtml}
                        </div>
                        <div class="room">
                            <span class="mobile-label">Rom:</span>
                            ${event.room}${riggIndicator}
                        </div>
                        <div class="teknikere ${teknikereClass}">
                            <span class="mobile-label">Tek:</span>
                            ${teknikereHtml}
                        </div>
                        <div class="arrangor">
                            <span class="mobile-label">Arrang√∏r:</span>
                            <span class="arrangor-title ${sanityClass}" data-drawer="drawer-${index}">
                                ${arrangorTruncated}
                                ${hasSanity ? '<span class="web-icon">üåê</span>' : ''}
                            </span>
                            <span class="active-indicator">‚óÑ</span>
                            <span class="getout-indicator">‚èè</span>
                        </div>
                        <div class="arr-tid">
                            <span class="mobile-label">Tid:</span>
                            ${event.arr_tid}
                        </div>
                        ${teknikerDrawerHtml}
                        ${drawerHtml}
                    </div>
                `;
            }).join('');
            
            // Legg til click handlers for tekniker-navn
            const teknikerNavnElements = document.querySelectorAll('.tekniker-navn');
            console.log('Tekniker-navn elementer funnet:', teknikerNavnElements.length);
            
            teknikerNavnElements.forEach(el => {
                el.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const teknikerId = this.dataset.tekniker;
                    console.log('Klikket p√• tekniker:', teknikerId);
                    const drawer = document.getElementById(`tekniker-drawer-${teknikerId}`);
                    console.log('Drawer funnet:', drawer);
                    
                    if (!drawer) {
                        console.error('Tekniker-drawer ikke funnet:', `tekniker-drawer-${teknikerId}`);
                        return;
                    }
                    
                    // Toggle drawer
                    const isOpen = drawer.classList.contains('open');
                    
                    // Lukk alle tekniker-drawers
                    document.querySelectorAll('.tekniker-drawer.open').forEach(d => d.classList.remove('open'));
                    document.querySelectorAll('.tekniker-navn.active').forEach(n => n.classList.remove('active'));
                    
                    if (!isOpen) {
                        drawer.classList.add('open');
                        this.classList.add('active');
                    }
                });
            });
            
            // Legg til click handlers for drawers
            document.querySelectorAll('.arrangor-title.has-sanity').forEach(el => {
                el.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const drawerId = this.dataset.drawer;
                    const drawer = document.getElementById(drawerId);
                    const parentRow = this.closest('.event-row');
                    
                    if (!drawer) {
                        console.error('Drawer not found:', drawerId);
                        return;
                    }
                    
                    // Toggle denne draweren
                    const isOpen = drawer.classList.contains('open');
                    
                    // Lukk alle andre drawers (inkl. tekniker)
                    document.querySelectorAll('.event-drawer.open').forEach(d => d.classList.remove('open'));
                    document.querySelectorAll('.tekniker-drawer.open').forEach(d => d.classList.remove('open'));
                    document.querySelectorAll('.arrangor-title.open').forEach(t => t.classList.remove('open'));
                    document.querySelectorAll('.event-row.has-drawer-open').forEach(r => r.classList.remove('has-drawer-open'));
                    
                    // Toggle denne
                    if (!isOpen) {
                        drawer.classList.add('open');
                        this.classList.add('open');
                        parentRow.classList.add('has-drawer-open');
                    }
                });
            });
            
            console.log('Drawer handlers attached:', document.querySelectorAll('.arrangor-title.has-sanity').length);
        }
        
        // Lukk drawer n√•r man klikker utenfor
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.arrangor-title') && !e.target.closest('.event-drawer') && !e.target.closest('.tekniker-navn') && !e.target.closest('.tekniker-drawer') && !e.target.closest('.vert-name') && !e.target.closest('.vert-drawer')) {
                document.querySelectorAll('.event-drawer.open').forEach(d => d.classList.remove('open'));
                document.querySelectorAll('.tekniker-drawer.open').forEach(d => d.classList.remove('open'));
                document.querySelectorAll('.vert-drawer.open').forEach(d => d.classList.remove('open'));
                document.querySelectorAll('.arrangor-title.open').forEach(t => t.classList.remove('open'));
                document.querySelectorAll('.tekniker-navn.active').forEach(n => n.classList.remove('active'));
                document.querySelectorAll('.vert-name.active').forEach(n => n.classList.remove('active'));
                document.querySelectorAll('.event-row.has-drawer-open').forEach(r => r.classList.remove('has-drawer-open'));
            }
        });
        
        function renderVerter(verter) {
            const container = document.getElementById('verter-container');
            
            if (!verter || verter.length === 0) {
                container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1">Ingen verter denne dagen</div>';
                return;
            }
            
            container.innerHTML = verter.map((vert, index) => `
                <div class="vert-card ${vert.active ? 'active' : ''}">
                    <span class="vert-name clickable" data-vert="${index}">${vert.name}</span>
                    <span class="vert-tid">${vert.tid}</span>
                    <div class="vert-drawer" id="vert-drawer-${index}">
                        <div class="vert-drawer-content">
                            <img src="${vert.bilde}" class="vert-bilde" alt="${vert.name}" onerror="this.style.display='none'">
                            <div class="vert-info">
                                <div class="vert-navn-full">${vert.name}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Legg til click handlers for vert-navn
            document.querySelectorAll('.vert-name.clickable').forEach(el => {
                el.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const vertId = this.dataset.vert;
                    const drawer = document.getElementById(`vert-drawer-${vertId}`);
                    
                    if (!drawer) return;
                    
                    // Toggle drawer
                    const isOpen = drawer.classList.contains('open');
                    
                    // Lukk alle vert-drawers
                    document.querySelectorAll('.vert-drawer.open').forEach(d => d.classList.remove('open'));
                    document.querySelectorAll('.vert-name.active').forEach(n => n.classList.remove('active'));
                    
                    if (!isOpen) {
                        drawer.classList.add('open');
                        this.classList.add('active');
                    }
                });
            });
        }
        
        function renderFinishedEvents(events) {
            const section = document.getElementById('finished-section');
            const container = document.getElementById('finished-events');
            const countEl = document.getElementById('finished-count');
            
            if (!events || events.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            countEl.textContent = events.length;
            
            container.innerHTML = events.map(event => {
                const riggTid = event.rigg_tid || '‚Äî';
                // Teknikere er n√• objekter med fornavn
                const teknikere = event.teknikere 
                    ? event.teknikere.map(t => t.fornavn).join(', ') 
                    : '‚Äî';
                const arrangor = event.arrangor || '(ingen)';
                const arrangorTruncated = arrangor.length > 30 ? arrangor.substring(0, 28) + '...' : arrangor;
                
                return `
                    <div class="event-row status-finished">
                        <div class="rigg-tid">${riggTid}</div>
                        <div class="room">${event.room}</div>
                        <div class="teknikere ${teknikere === '‚Äî' ? 'empty' : ''}">${teknikere}</div>
                        <div class="arrangor">
                            <span title="${arrangor}">${arrangorTruncated}</span>
                            ‚úì
                        </div>
                        <div class="arr-tid">${event.arr_tid}</div>
                    </div>
                `;
            }).join('');
        }
        
        // Toggle for ferdige arrangementer
        document.getElementById('finished-toggle').addEventListener('click', function() {
            this.classList.toggle('open');
            document.getElementById('finished-container').classList.toggle('open');
        });
        
        // Initial load
        loadData();
        
        // Auto-refresh every 60 seconds (bare UI, data oppdateres i bakgrunnen p√• server)
        refreshInterval = setInterval(loadData, 60000);
        
        // Visibility API - pause refresh when tab is hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                clearInterval(refreshInterval);
            } else {
                loadData();
                refreshInterval = setInterval(loadData, 60000);
            }
        });
        
        // Manuell refresh-knapp
        document.getElementById('refresh-btn').addEventListener('click', async function() {
            const btn = this;
            btn.disabled = true;
            btn.classList.add('loading');
            
            try {
                // Trigger server-side refresh
                await fetch('/api/refresh', { method: 'POST' });
                
                // Vent litt s√• serveren rekker √• oppdatere
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Last inn ny data
                await loadData();
                
            } catch (error) {
                console.error('Refresh error:', error);
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
            }
        });
        
        // Hent og vis sist oppdatert tid
        async function updateLastRefreshTime() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                if (status.today_updated) {
                    const updated = new Date(status.today_updated);
                    const now = new Date();
                    const diffMin = Math.floor((now - updated) / 60000);
                    
                    let timeText;
                    if (diffMin < 1) {
                        timeText = 'n√•';
                    } else if (diffMin < 60) {
                        timeText = `${diffMin} min siden`;
                    } else {
                        timeText = updated.toLocaleTimeString('no-NO', { hour: '2-digit', minute: '2-digit' });
                    }
                    
                    document.getElementById('last-update').textContent = timeText;
                }
            } catch (e) {
                console.error('Status error:', e);
            }
        }
        
        // Oppdater "sist oppdatert" hvert 30. sekund
        updateLastRefreshTime();
        setInterval(updateLastRefreshTime, 30000);
    </script>
</body>
</html>
